<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Orchestrator - Admin Dashboard</title>

    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6200ea;
            --primary-dark: #4a00b8;
            --primary-light: #7c4dff;
            --accent: #03dac6;
            --error: #cf6679;
            --background: #f5f5f5;
            --surface: #ffffff;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border: #e0e0e0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.8;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            display: flex;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(98, 0, 234, 0.04);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .form-field {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(98, 0, 234, 0.1);
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #b85565;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            background: transparent;
            color: var(--primary);
            box-shadow: none;
            padding: 8px;
        }

        .btn-icon:hover {
            background: rgba(98, 0, 234, 0.08);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
        }

        th {
            background: var(--primary);
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(98, 0, 234, 0.02);
        }

        /* Alerts */
        .alert {
            padding: 16px 24px;
            border-radius: 4px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-error {
            background: #ffebee;
            color: #c62828;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .material-icons {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Truncate */
        .truncate {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }

        /* Action buttons group */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>
                <span class="material-icons">dashboard</span>
                Voice Orchestrator Admin
            </h1>
            <div class="header-subtitle">Complete management dashboard for users, homes, and Alexa mappings</div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-role">Administrator</div>
            </div>
            <button class="btn-logout" onclick="logout()">
                <span class="material-icons">logout</span>
                Logout
            </button>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Alert Box -->
        <div id="alertBox" class="alert"></div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">
                <span class="material-icons">dashboard</span>
                Overview
            </button>
            <button class="nav-tab" onclick="switchTab('users')">
                <span class="material-icons">people</span>
                Users
            </button>
            <button class="nav-tab" onclick="switchTab('homes')">
                <span class="material-icons">home</span>
                Homes
            </button>
            <button class="nav-tab" onclick="switchTab('mappings')">
                <span class="material-icons">link</span>
                Alexa Mappings
            </button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-homes">0</div>
                    <div class="stat-label">Total Homes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-mappings">0</div>
                    <div class="stat-label">Alexa Mappings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-test-mode">0</div>
                    <div class="stat-label">Test Mode Active</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span class="material-icons">info</span>
                    Quick Start Guide
                </div>
                <ol style="line-height: 2; padding-left: 20px;">
                    <li><strong>Create a User</strong> - Go to Users tab and add a new user</li>
                    <li><strong>Create a Home</strong> - Go to Homes tab and register their home with Home Assistant URL</li>
                    <li><strong>Enable Test Mode</strong> - Toggle test mode for the home to test without Home Assistant</li>
                    <li><strong>Add Alexa Mapping</strong> - Go to Alexa Mappings tab and link their Alexa user ID to the home</li>
                    <li><strong>Test</strong> - User can now use Alexa skill in test mode</li>
                    <li><strong>Production</strong> - Disable test mode when ready for real Home Assistant integration</li>
                </ol>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content">
            <!-- Create User Form -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">person_add</span>
                    Create New User
                </div>
                <form id="createUserForm">
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="form-label" for="user-username">Username *</label>
                            <input type="text" id="user-username" class="form-input" required>
                            <div class="form-hint">Unique username for login</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="user-fullname">Full Name *</label>
                            <input type="text" id="user-fullname" class="form-input" required>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="user-email">Email</label>
                            <input type="email" id="user-email" class="form-input">
                            <div class="form-hint">Optional</div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Create User
                    </button>
                </form>
            </div>

            <!-- Users List -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">people</span>
                    All Users
                </div>
                <div id="usersLoading" class="loading">
                    <div class="spinner"></div>
                    Loading users...
                </div>
                <div id="usersTable" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="usersEmpty" class="empty-state" style="display: none;">
                    <span class="material-icons">people_outline</span>
                    <div>No users found. Create one above to get started.</div>
                </div>
            </div>
        </div>

        <!-- Homes Tab -->
        <div id="tab-homes" class="tab-content">
            <!-- Create Home Form -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">add_home</span>
                    Register New Home
                </div>
                <form id="createHomeForm">
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="form-label" for="home-id">Home ID *</label>
                            <input type="text" id="home-id" class="form-input" required>
                            <div class="form-hint">Unique identifier (e.g., karthi_home)</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="home-user">User *</label>
                            <select id="home-user" class="form-input" required>
                                <option value="">-- Select User --</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="home-name">Home Name *</label>
                            <input type="text" id="home-name" class="form-input" required>
                            <div class="form-hint">Display name (e.g., Karthi's Main House)</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="home-ha-url">Home Assistant URL *</label>
                            <input type="url" id="home-ha-url" class="form-input" required>
                            <div class="form-hint">e.g., https://ha1.homeadapt.us</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="home-webhook">Webhook ID *</label>
                            <input type="text" id="home-webhook" class="form-input" required>
                            <div class="form-hint">Home Assistant webhook ID</div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Create Home
                    </button>
                </form>
            </div>

            <!-- Homes List -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">home_work</span>
                    All Homes
                </div>
                <div id="homesLoading" class="loading">
                    <div class="spinner"></div>
                    Loading homes...
                </div>
                <div id="homesTable" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Home ID</th>
                                    <th>Name</th>
                                    <th>User</th>
                                    <th>HA URL</th>
                                    <th>Webhook ID</th>
                                    <th>Status</th>
                                    <th>Test Mode</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="homesBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="homesEmpty" class="empty-state" style="display: none;">
                    <span class="material-icons">home_work</span>
                    <div>No homes found. Create one above to get started.</div>
                </div>
            </div>
        </div>

        <!-- Alexa Mappings Tab -->
        <div id="tab-mappings" class="tab-content">
            <!-- Create Mapping Form -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">add_link</span>
                    Add New Alexa Mapping
                </div>
                <form id="createMappingForm">
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="form-label" for="mapping-alexa-id">Alexa User ID *</label>
                            <input type="text" id="mapping-alexa-id" class="form-input" required>
                            <div class="form-hint">Find this in server logs when user tries to use the skill</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="mapping-home">Home *</label>
                            <select id="mapping-home" class="form-input" required>
                                <option value="">-- Select Home --</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Create Mapping
                    </button>
                </form>
            </div>

            <!-- Mappings List -->
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">link</span>
                    Existing Alexa Mappings
                </div>
                <div id="mappingsLoading" class="loading">
                    <div class="spinner"></div>
                    Loading mappings...
                </div>
                <div id="mappingsTable" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Alexa User ID</th>
                                    <th>Home ID</th>
                                    <th>Home Name</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mappingsBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="mappingsEmpty" class="empty-state" style="display: none;">
                    <span class="material-icons">link_off</span>
                    <div>No mappings found. Add one above to get started.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin';
        let allUsers = [];
        let allHomes = [];
        let allMappings = [];

        // Check authentication on load
        async function checkAuth() {
            try {
                const response = await fetch('/auth/check');
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/static/login.html';
                    return false;
                } else {
                    document.getElementById('userName').textContent = data.user.full_name;
                    return true;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/static/login.html';
                return false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                window.location.href = '/static/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/static/login.html';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Reload data for the active tab
            if (tabName === 'users') loadUsers();
            if (tabName === 'homes') loadHomes();
            if (tabName === 'mappings') loadMappings();
        }

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
                ${message}
            `;
            alertBox.style.display = 'flex';
            window.scrollTo(0, 0);
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        // Load statistics
        async function loadStats() {
            try {
                const [usersResp, homesResp, mappingsResp] = await Promise.all([
                    fetch(`${API_BASE}/users`),
                    fetch(`${API_BASE}/homes`),
                    fetch(`${API_BASE}/alexa-mappings`)
                ]);

                const users = await usersResp.json();
                const homes = await homesResp.json();
                const mappings = await mappingsResp.json();

                document.getElementById('stat-users').textContent = users.total || 0;
                document.getElementById('stat-homes').textContent = homes.total || 0;
                document.getElementById('stat-mappings').textContent = mappings.total || 0;

                const testModeCount = homes.homes ? homes.homes.filter(h => h.test_mode).length : 0;
                document.getElementById('stat-test-mode').textContent = testModeCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // === USERS ===
        async function loadUsers() {
            try {
                document.getElementById('usersLoading').style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
                document.getElementById('usersEmpty').style.display = 'none';

                const response = await fetch(`${API_BASE}/users`);
                const data = await response.json();
                allUsers = data.users || [];

                if (allUsers.length > 0) {
                    renderUsers(allUsers);
                    document.getElementById('usersTable').style.display = 'block';
                } else {
                    document.getElementById('usersEmpty').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Failed to load users', 'error');
            } finally {
                document.getElementById('usersLoading').style.display = 'none';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><span class="truncate" title="${user.user_id}">${user.user_id}</span></td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.full_name}</td>
                    <td>${user.email || '-'}</td>
                    <td>
                        <span class="badge ${user.is_active ? 'badge-success' : 'badge-error'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-icon btn-small" onclick="viewUserHomes('${user.user_id}')" title="View Homes">
                                <span class="material-icons">home</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('user-username').value;
            const fullName = document.getElementById('user-fullname').value;
            const email = document.getElementById('user-email').value;

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        full_name: fullName,
                        email: email || null
                    })
                });

                if (response.ok) {
                    showAlert('User created successfully!', 'success');
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                    loadStats();
                    loadUserDropdowns();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to create user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('Failed to create user', 'error');
            }
        });

        function viewUserHomes(userId) {
            switchTab('homes');
            // Filter homes by user
            const userHomes = allHomes.filter(h => h.user_id === userId);
            if (userHomes.length > 0) {
                renderHomes(userHomes);
            } else {
                showAlert(`No homes found for this user`, 'info');
            }
        }

        // === HOMES ===
        async function loadHomes() {
            try {
                document.getElementById('homesLoading').style.display = 'block';
                document.getElementById('homesTable').style.display = 'none';
                document.getElementById('homesEmpty').style.display = 'none';

                const response = await fetch(`${API_BASE}/homes`);
                const data = await response.json();
                allHomes = data.homes || [];

                if (allHomes.length > 0) {
                    renderHomes(allHomes);
                    document.getElementById('homesTable').style.display = 'block';
                } else {
                    document.getElementById('homesEmpty').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading homes:', error);
                showAlert('Failed to load homes', 'error');
            } finally {
                document.getElementById('homesLoading').style.display = 'none';
            }
        }

        function renderHomes(homes) {
            const tbody = document.getElementById('homesBody');
            tbody.innerHTML = homes.map(home => `
                <tr>
                    <td><strong>${home.home_id}</strong></td>
                    <td>${home.name}</td>
                    <td><span class="truncate" title="${home.user_id}">${home.user_id}</span></td>
                    <td><span class="truncate" title="${home.ha_url}">${home.ha_url}</span></td>
                    <td>${home.ha_webhook_id}</td>
                    <td>
                        <span class="badge ${home.is_active ? 'badge-success' : 'badge-error'}">
                            ${home.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" ${home.test_mode ? 'checked' : ''}
                                   onchange="toggleTestMode('${home.home_id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-icon btn-small" onclick="editHome('${home.home_id}')" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleTestMode(homeId, enabled) {
            try {
                const response = await fetch(`${API_BASE}/homes/${homeId}/test-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                if (response.ok) {
                    showAlert(`Test mode ${enabled ? 'enabled' : 'disabled'} for ${homeId}`, 'success');
                    loadHomes();
                    loadStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to toggle test mode', 'error');
                    loadHomes(); // Reload to revert toggle
                }
            } catch (error) {
                console.error('Error toggling test mode:', error);
                showAlert('Failed to toggle test mode', 'error');
                loadHomes();
            }
        }

        function editHome(homeId) {
            // TODO: Implement edit functionality
            showAlert('Edit functionality coming soon!', 'info');
        }

        async function loadUserDropdowns() {
            const response = await fetch(`${API_BASE}/users`);
            const data = await response.json();
            const users = data.users || [];

            const select = document.getElementById('home-user');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                users.map(u => `<option value="${u.user_id}">${u.full_name} (${u.username})</option>`).join('');
        }

        document.getElementById('createHomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const homeId = document.getElementById('home-id').value;
            const userId = document.getElementById('home-user').value;
            const name = document.getElementById('home-name').value;
            const haUrl = document.getElementById('home-ha-url').value;
            const webhook = document.getElementById('home-webhook').value;

            try {
                const response = await fetch(`${API_BASE}/homes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        home_id: homeId,
                        user_id: userId,
                        name: name,
                        ha_url: haUrl,
                        ha_webhook_id: webhook
                    })
                });

                if (response.ok) {
                    showAlert('Home created successfully!', 'success');
                    document.getElementById('createHomeForm').reset();
                    loadHomes();
                    loadStats();
                    loadHomeDropdowns();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to create home', 'error');
                }
            } catch (error) {
                console.error('Error creating home:', error);
                showAlert('Failed to create home', 'error');
            }
        });

        // === MAPPINGS ===
        async function loadMappings() {
            try {
                document.getElementById('mappingsLoading').style.display = 'block';
                document.getElementById('mappingsTable').style.display = 'none';
                document.getElementById('mappingsEmpty').style.display = 'none';

                const [mappingsResp, homesResp] = await Promise.all([
                    fetch(`${API_BASE}/alexa-mappings`),
                    fetch(`${API_BASE}/homes`)
                ]);

                const mappingsData = await mappingsResp.json();
                const homesData = await homesResp.json();

                allMappings = mappingsData.mappings || [];
                const homesMap = {};
                (homesData.homes || []).forEach(h => homesMap[h.home_id] = h.name);

                if (allMappings.length > 0) {
                    renderMappings(allMappings, homesMap);
                    document.getElementById('mappingsTable').style.display = 'block';
                } else {
                    document.getElementById('mappingsEmpty').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading mappings:', error);
                showAlert('Failed to load mappings', 'error');
            } finally {
                document.getElementById('mappingsLoading').style.display = 'none';
            }
        }

        function renderMappings(mappings, homesMap) {
            const tbody = document.getElementById('mappingsBody');
            tbody.innerHTML = mappings.map(mapping => `
                <tr>
                    <td><span class="truncate" title="${mapping.alexa_user_id}">${mapping.alexa_user_id}</span></td>
                    <td>${mapping.home_id}</td>
                    <td>${homesMap[mapping.home_id] || '-'}</td>
                    <td>${formatDate(mapping.created_at)}</td>
                    <td>
                        <button class="btn btn-danger btn-small"
                                onclick="deleteMapping('${encodeURIComponent(mapping.alexa_user_id)}')">
                            <span class="material-icons">delete</span>
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadHomeDropdowns() {
            const response = await fetch(`${API_BASE}/homes`);
            const data = await response.json();
            const homes = data.homes || [];

            const select = document.getElementById('mapping-home');
            select.innerHTML = '<option value="">-- Select Home --</option>' +
                homes.map(h => `<option value="${h.home_id}">${h.name} (${h.home_id})</option>`).join('');
        }

        document.getElementById('createMappingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const alexaUserId = document.getElementById('mapping-alexa-id').value;
            const homeId = document.getElementById('mapping-home').value;

            try {
                const response = await fetch(`${API_BASE}/alexa-mappings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        alexa_user_id: alexaUserId,
                        home_id: homeId
                    })
                });

                if (response.ok) {
                    showAlert('Alexa mapping created successfully!', 'success');
                    document.getElementById('createMappingForm').reset();
                    loadMappings();
                    loadStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to create mapping', 'error');
                }
            } catch (error) {
                console.error('Error creating mapping:', error);
                showAlert('Failed to create mapping', 'error');
            }
        });

        async function deleteMapping(alexaUserId) {
            if (!confirm('Are you sure you want to delete this mapping?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/alexa-mappings/${alexaUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Mapping deleted successfully!', 'success');
                    loadMappings();
                    loadStats();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to delete mapping', 'error');
                }
            } catch (error) {
                console.error('Error deleting mapping:', error);
                showAlert('Failed to delete mapping', 'error');
            }
        }

        // Initialize
        checkAuth().then(authenticated => {
            if (authenticated) {
                loadStats();
                loadUsers();
                loadUserDropdowns();
                loadHomeDropdowns();
            }
        });
    </script>
</body>
</html>
